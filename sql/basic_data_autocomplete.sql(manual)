-- Completar tramo, via, banda automaticamente excluyendo zonas de interseccion con distribuidores
-- Paso 2: Generar puntos solo en 치reas no excluidas
WITH carrile_points AS (
    SELECT 
        c.id,
        ST_PointOnSurface(c.geom)::geometry(Point, 5348) AS punto  -- Mismo SRID
    FROM gisdata.velocidades c
    WHERE NOT EXISTS (
        SELECT 1
        FROM gisdata.v_exclusion_zones ez
        WHERE ST_Intersects(c.geom, ez.geom)
    )
)

-- Paso 3: Actualizaci칩n con verificaci칩n SRID
UPDATE gisdata.velocidades AS cp
SET 
    id_tramo = b.id_tramo,
    id_via = b.id_via,
	id_banda =b.id_banda
FROM (
    SELECT DISTINCT ON (cp.id)
        cp.id,
        b.id_tramo,
        b.id_via,
		b.id_banda,
        ST_Distance(cp.punto, b.geom) AS distancia
    FROM carrile_points cp
    JOIN gisdata.bandas_geo b 
        ON ST_Intersects(cp.punto, b.geom)
        AND ST_SRID(cp.punto) = ST_SRID(b.geom)  -- Verificar SRID
    WHERE ST_IsValid(cp.punto)
    ORDER BY cp.id, distancia ASC  -- Priorizar banda m치s cercana
) AS b
